<!DOCTYPE html>
<html>

<head>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <title>Reset Password - Profile</title>
    <style>
        body {
            font-family: 'Amiri', serif;
            display: flex;
            justify-content: center;
            background-image: url("/background.jpg");
            background-size: cover;
            background-position: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .reset-password-container {
            background-color: #fcedda;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .reset-password-container h2 {
            color: #ee4e34;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .reset-password-container h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .reset-password-container p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .reset-password-container form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .textbox-border {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .textbox-border:focus {
            outline: none;
            border-color: #ee4e34;
        }

        .security-question {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: left;
            border-left: 4px solid #ee4e34;
        }

        .security-question label {
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .security-question p {
            margin: 0;
            color: #666;
            font-style: italic;
            font-size: 16px;
        }

        .current-password-section {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .current-password-section.show {
            display: flex;
        }

        .password-fields {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .password-requirements {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            margin-bottom: 15px;
        }

        .password-requirements p {
            margin: 0 0 10px 0;
            color: #333;
            font-weight: bold;
        }

        .password-requirements ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
        }

        .password-requirements li {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .password-fields.show {
            display: flex;
        }

        button {
            padding: 12px 20px;
            background-color: #ee4e34;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #ff6347;
        }

        .back-button {
            background-color: #666;
        }

        .back-button:hover {
            background-color: #555;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .button-group button {
            flex: 1;
        }

        .success-message {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        .error-message {
            color: #dc3545;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
        }

        .step.active {
            background-color: #ee4e34;
            color: white;
        }

        .step.completed {
            background-color: #28a745;
            color: white;
        }

        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container input {
            flex: 1;
            padding-right: 50px;
        }

        .toggle-password {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
            color: #666;
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #ee4e34;
            background-color: rgba(238, 78, 52, 0.1);
        }

        .toggle-password.active {
            color: #ee4e34;
        }

        .eye-icon {
            font-size: 18px;
        }
    </style>
</head>

<body>
    {{> messages}}
    
    {{#if showPreviousPasswordAlert}}
    <script>
        // Show alert for previous password usage
        alert("Error: New password cannot be the same as any of your previous passwords. Please choose a different password.");
    </script>
    {{/if}}
    
    <div class="reset-password-container">
        <h2>Reset Password</h2>
        
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <form id="resetPasswordForm">
            <h1>Step 1: Verify Current Password</h1>
            <p>Please enter your current password to continue.</p>

            <div class="password-input-container">
                <input type="password" id="currentPassword" name="currentPassword" class="textbox-border"
                    placeholder="Current Password" required>
                <button type="button" class="toggle-password" onclick="togglePassword('currentPassword')">
                    <span class="eye-icon">üëÅÔ∏è</span>
                </button>
            </div>

            <div class="success-message" id="currentPasswordSuccess">‚úì Current password verified!</div>
            <div class="error-message" id="currentPasswordError">‚úó Incorrect current password. Please try again.</div>

            <div class="current-password-section show" id="currentPasswordSection">
                <div class="button-group">
                    <button type="button" id="verifyCurrentPasswordBtn" onclick="verifyCurrentPassword()">Verify Current Password</button>
                    <button type="button" class="back-button"
                        onclick="window.location.href='/profile?user={{username}}'">Back to Profile</button>
                </div>
            </div>

            <div class="security-question" id="securityQuestionSection" style="display: none;">
                <label><strong>Security Question:</strong></label>
                <p>{{securityQuestion}}</p>
            </div>

            <input type="password" id="securityAnswer" name="securityAnswer" class="textbox-border"
                placeholder="Your Answer" required style="display: none;">

            <div class="success-message" id="securityAnswerSuccess" style="display: none;">‚úì Security answer is correct!</div>
            <div class="error-message" id="securityAnswerError" style="display: none;">‚úó Incorrect answer. Please try again.</div>

            <div class="password-fields" id="passwordFields">
                <div class="password-requirements">
                    <p><strong>Password Requirements:</strong></p>
                    <ul>
                        <li>At least 8 characters long</li>
                        <li>Include uppercase letter (A-Z)</li>
                        <li>Include lowercase letter (a-z)</li>
                        <li>Include number (0-9)</li>
                        <li>Include special character (!@#$%^&*...)</li>
                        <li>Cannot be the same as your current password</li>
                        <li>Cannot be the same as any of your previous 5 passwords</li>
                    </ul>
                </div>
                <div class="password-input-container">
                    <input type="password" id="newPassword" name="newPassword" class="textbox-border"
                        placeholder="New Password" required>
                    <button type="button" class="toggle-password" onclick="togglePassword('newPassword')">
                        <span class="eye-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                <div class="password-input-container">
                    <input type="password" id="confirmPassword" name="confirmPassword" class="textbox-border"
                        placeholder="Confirm New Password" required>
                    <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                        <span class="eye-icon">üëÅÔ∏è</span>
                    </button>
                </div>
            </div>

            <div class="button-group" id="finalButtons" style="display: none;">
                <button type="button" id="verifySecurityBtn" onclick="verifySecurityAnswer()">Verify Security Answer</button>
                <button type="button" id="resetPasswordBtn" onclick="submitResetPassword()">Reset Password</button>
                <button type="button" class="back-button"
                    onclick="window.location.href='/profile?user={{username}}'">Back to Profile</button>
            </div>
        </form>
    </div>

    <script>
        let currentStep = 1;
        let currentPasswordVerified = false;
        let securityAnswerVerified = false;

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentElement.querySelector('.toggle-password');
            const eyeIcon = button.querySelector('.eye-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.classList.add('active');
                eyeIcon.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.classList.remove('active');
                eyeIcon.textContent = 'üëÅÔ∏è';
            }
        }

        function updateStepIndicator() {
            document.getElementById('step1').className = 'step ' + (currentStep >= 1 ? 'completed' : 'active');
            document.getElementById('step2').className = 'step ' + (currentStep >= 2 ? 'completed' : (currentStep === 2 ? 'active' : ''));
            document.getElementById('step3').className = 'step ' + (currentStep >= 3 ? 'completed' : (currentStep === 3 ? 'active' : ''));
        }

        function verifyCurrentPassword() {
            var currentPassword = document.getElementById("currentPassword").value;

            if (!currentPassword) {
                alert("Please enter your current password.");
                return;
            }

            var formData = new FormData();
            formData.append("currentPassword", currentPassword);

            fetch("/verify-current-password", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Show success message and move to next step
                        document.getElementById("currentPasswordSuccess").style.display = "block";
                        document.getElementById("currentPasswordError").style.display = "none";
                        currentPasswordVerified = true;
                        
                        // Move to step 2
                        currentStep = 2;
                        updateStepIndicator();
                        
                        // Show security question section
                        document.getElementById("securityQuestionSection").style.display = "block";
                        document.getElementById("securityAnswer").style.display = "block";
                        document.getElementById("finalButtons").style.display = "flex";
                        
                        // Update form title
                        document.querySelector("h1").textContent = "Step 2: Answer Security Question";
                        document.querySelector("p").textContent = "Please answer your security question to continue.";
                        
                    } else {
                        // Show error message
                        document.getElementById("currentPasswordError").style.display = "block";
                        document.getElementById("currentPasswordSuccess").style.display = "none";
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred. Please try again.");
                });
        }

        function verifySecurityAnswer() {
            var securityAnswer = document.getElementById("securityAnswer").value;

            if (!securityAnswer) {
                alert("Please enter your security answer.");
                return;
            }

            var formData = new FormData();
            formData.append("securityAnswer", securityAnswer);

            fetch("/profile/verify-security-answer", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Show success message and password fields
                        document.getElementById("securityAnswerSuccess").style.display = "block";
                        document.getElementById("securityAnswerError").style.display = "none";
                        document.getElementById("passwordFields").classList.add("show");
                        document.getElementById("verifySecurityBtn").style.display = "none";
                        document.getElementById("resetPasswordBtn").style.display = "block";
                        securityAnswerVerified = true;
                        
                        // Move to step 3
                        currentStep = 3;
                        updateStepIndicator();
                        
                        // Update form title
                        document.querySelector("h1").textContent = "Step 3: Enter New Password";
                        document.querySelector("p").textContent = "Please enter your new password.";
                        
                    } else {
                        // Show error message
                        document.getElementById("securityAnswerError").style.display = "block";
                        document.getElementById("securityAnswerSuccess").style.display = "none";
                        document.getElementById("passwordFields").classList.remove("show");
                        document.getElementById("resetPasswordBtn").style.display = "none";
                        document.getElementById("verifySecurityBtn").style.display = "block";
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred. Please try again.");
                });
        }

        function submitResetPassword() {
            var newPassword = document.getElementById("newPassword").value;
            var confirmPassword = document.getElementById("confirmPassword").value;
            var currentPassword = document.getElementById("currentPassword").value;

            if (!newPassword || !confirmPassword) {
                alert("Please fill in all password fields.");
                return;
            }

            if (newPassword !== confirmPassword) {
                alert("Passwords do not match.");
                return;
            }

            // Client-side password complexity validation
            if (newPassword.length < 8) {
                alert("Password must be at least 8 characters long.");
                return;
            }
            
            if (!/[a-z]/.test(newPassword)) {
                alert("Password must include at least one lowercase letter.");
                return;
            }
            
            if (!/[A-Z]/.test(newPassword)) {
                alert("Password must include at least one uppercase letter.");
                return;
            }
            
            if (!/[0-9]/.test(newPassword)) {
                alert("Password must include at least one number.");
                return;
            }
            
            if (!/[^A-Za-z0-9]/.test(newPassword)) {
                alert("Password must include at least one special character.");
                return;
            }

            var formData = new FormData();
            formData.append("newPassword", newPassword);
            formData.append("confirmPassword", confirmPassword);
            formData.append("currentPassword", currentPassword);

            fetch("/profile/reset-password", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Password reset successful
                        alert("Password reset successfully!");
                        window.location.href = "/profile?user=" + "{{username}}";
                    } else {
                        // Show error message
                        alert(data.message);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred. Please try again.");
                });
        }
    </script>
</body>

</html> 